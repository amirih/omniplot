

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>omniplot.scatter &mdash; omniplot 0.3.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> omniplot
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">omniplot</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>omniplot.scatter</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for omniplot.scatter</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">import</span> <span class="nn">matplotlib.collections</span> <span class="k">as</span> <span class="nn">mc</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">from</span> <span class="nn">matplotlib.lines</span> <span class="kn">import</span> <span class="n">Line2D</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.hierarchy</span> <span class="kn">import</span> <span class="n">leaves_list</span>
<span class="kn">from</span> <span class="nn">scipy.cluster</span> <span class="kn">import</span> <span class="n">hierarchy</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span>
<span class="kn">from</span> <span class="nn">natsort</span> <span class="kn">import</span> <span class="n">natsort_keygen</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>
<span class="kn">import</span> <span class="nn">scipy.cluster.hierarchy</span> <span class="k">as</span> <span class="nn">sch</span>
<span class="kn">import</span> <span class="nn">fastcluster</span> <span class="k">as</span> <span class="nn">fcl</span>

<span class="kn">import</span> <span class="nn">sys</span> 
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span><span class="p">,</span> <span class="n">DBSCAN</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">silhouette_score</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">pdist</span><span class="p">,</span> <span class="n">squareform</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span><span class="p">,</span> <span class="n">NMF</span><span class="p">,</span> <span class="n">LatentDirichletAllocation</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">fisher_exact</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">zscore</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1">#script_dir = os.path.dirname( __file__ )</span>
<span class="c1">#sys.path.append( script_dir )</span>
<span class="kn">from</span> <span class="nn">omniplot.utils</span> <span class="kn">import</span> <span class="n">_create_color_markerlut</span><span class="p">,</span> <span class="n">_separate_data</span><span class="p">,</span> <span class="n">_line_annotate</span><span class="p">,</span> <span class="n">_dendrogram_threshold</span><span class="p">,</span> <span class="n">_radialtree2</span><span class="p">,</span><span class="n">_get_cluster_classes</span><span class="p">,</span><span class="n">_calc_curveture</span><span class="p">,</span> <span class="n">_draw_ci_pi</span><span class="p">,</span><span class="n">_calc_r2</span><span class="p">,</span><span class="n">_ci_pi</span><span class="p">,</span> <span class="n">_save</span><span class="p">,</span> <span class="n">_baumkuchen_xy</span><span class="p">,</span> <span class="n">_get_embedding</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="kn">from</span> <span class="nn">omniplot.chipseq_utils</span> <span class="kn">import</span> <span class="n">_calc_pearson</span>
<span class="kn">import</span> <span class="nn">itertools</span> <span class="k">as</span> <span class="nn">it</span>

<span class="n">colormap_list</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nipy_spectral&quot;</span><span class="p">,</span> <span class="s2">&quot;terrain&quot;</span><span class="p">,</span><span class="s2">&quot;tab20b&quot;</span><span class="p">,</span><span class="s2">&quot;tab20c&quot;</span><span class="p">,</span><span class="s2">&quot;gist_rainbow&quot;</span><span class="p">,</span><span class="s2">&quot;hsv&quot;</span><span class="p">,</span><span class="s2">&quot;CMRmap&quot;</span><span class="p">,</span><span class="s2">&quot;coolwarm&quot;</span><span class="p">,</span><span class="s2">&quot;gnuplot&quot;</span><span class="p">,</span><span class="s2">&quot;gist_stern&quot;</span><span class="p">,</span><span class="s2">&quot;brg&quot;</span><span class="p">,</span><span class="s2">&quot;rainbow&quot;</span><span class="p">,</span><span class="s2">&quot;jet&quot;</span><span class="p">]</span>
<span class="n">hatch_list</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;//&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;||&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;++&#39;</span><span class="p">,</span> <span class="s1">&#39;xx&#39;</span><span class="p">,</span> <span class="s1">&#39;oo&#39;</span><span class="p">,</span> <span class="s1">&#39;OO&#39;</span><span class="p">,</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="s1">&#39;**&#39;</span><span class="p">,</span><span class="s1">&#39;/o&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">|&#39;</span><span class="p">,</span> <span class="s1">&#39;|*&#39;</span><span class="p">,</span> <span class="s1">&#39;-</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;+o&#39;</span><span class="p">,</span> <span class="s1">&#39;x*&#39;</span><span class="p">,</span> <span class="s1">&#39;o-&#39;</span><span class="p">,</span> <span class="s1">&#39;O|&#39;</span><span class="p">,</span> <span class="s1">&#39;O.&#39;</span><span class="p">,</span> <span class="s1">&#39;*-&#39;</span><span class="p">]</span>
<span class="n">maker_list</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span> <span class="p">,</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;4&#39;</span><span class="p">,</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.family&#39;</span><span class="p">]</span><span class="o">=</span> <span class="s1">&#39;sans-serif&#39;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.sans-serif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Arial&#39;</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;svg.fonttype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_theme</span><span class="p">(</span><span class="n">font</span><span class="o">=</span><span class="s2">&quot;Arial&quot;</span><span class="p">)</span>

<span class="n">__all__</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;clusterplot&quot;</span><span class="p">,</span> <span class="s2">&quot;decomplot&quot;</span><span class="p">,</span> <span class="s2">&quot;pie_scatter&quot;</span><span class="p">,</span><span class="s2">&quot;manifoldplot&quot;</span><span class="p">,</span> <span class="s2">&quot;regression_single&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="clusterplot"><a class="viewcode-back" href="../../omniplot.html#omniplot.scatter.clusterplot">[docs]</a><span class="k">def</span> <span class="nf">clusterplot</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                <span class="n">variables</span><span class="p">:</span> <span class="n">List</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">category</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> 
                <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;kmeans&quot;</span><span class="p">,</span>
                <span class="n">n_clusters</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span> <span class="p">,</span> <span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">y</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">size</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">reduce_dimension</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;umap&quot;</span><span class="p">,</span> 
                <span class="n">testrange</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span><span class="p">],</span>
                <span class="n">topn_cluster_num</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">min_dist</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                <span class="n">n_neighbors</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                <span class="n">eps</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">pcacomponent</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">ztranform</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">palette</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Spectral&quot;</span><span class="p">,</span><span class="s2">&quot;tab20b&quot;</span><span class="p">],</span>
                <span class="n">save</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">markers</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">piesize_scale</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
                <span class="n">min_cluster_size</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clustering data and draw them as a scatter plot optionally with dimensionality reduction.  </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas DataFrame</span>
<span class="sd">    x, y: str, optional</span>
<span class="sd">        The column names to be the x and y axes of scatter plots. If reduce_dimension=True, these options will be</span>
<span class="sd">        ignored.</span>
<span class="sd">    </span>
<span class="sd">    variables: list, optional</span>
<span class="sd">        The names of variables to calculate clusters..</span>
<span class="sd">    </span>
<span class="sd">    category: str, optional</span>
<span class="sd">        the column name of a known sample category (if exists). </span>
<span class="sd">    method: str</span>
<span class="sd">        Method name for clustering. </span>
<span class="sd">        &quot;kmeans&quot;</span>
<span class="sd">        &quot;hierarchical&quot;,</span>
<span class="sd">        &quot;dbscan&quot;: Density-Based Clustering Algorithms</span>
<span class="sd">        &quot;fuzzy&quot; : fuzzy c-mean clustering using scikit-fuzzy</span>
<span class="sd">    n_clusters: int or str, optional (default: 3)</span>
<span class="sd">        The number of clusters to be created. If &quot;auto&quot; is provided, it will estimate optimal </span>
<span class="sd">        cluster numbers with &quot;Sum of squared distances&quot; for k-mean clustering and silhouette method for others. </span>
<span class="sd">    eps: int or list[int]</span>
<span class="sd">        DBSCAN&#39;s hyper parameter. It will affect the total number of clusters. </span>
<span class="sd">    reduce_dimension: str, optional (default: &quot;umap&quot;)</span>
<span class="sd">        Dimensionality reduction method. if &quot;&quot; is passed, no reduction methods are applied. </span>
<span class="sd">        In this case, data must have only two dimentions or x and y options must be specified.</span>
<span class="sd">    </span>
<span class="sd">    markers: bool, optional (default: False)</span>
<span class="sd">        Whether to use different markers for each cluster/category (for a colorblind-friendly plot).</span>
<span class="sd">    show: bool, optional (default: False)</span>
<span class="sd">        Whether to show figures</span>
<span class="sd">    size: float, optional (default: 10)</span>
<span class="sd">        The size of points in the scatter plot.</span>
<span class="sd">        </span>
<span class="sd">    testrange: list, optional (default: [1,20])</span>
<span class="sd">        The range of cluster numbers to be tested when n_clusters=&quot;auto&quot;.</span>
<span class="sd">    topn_cluster_num: int, optional (default: 2)</span>
<span class="sd">        Top n optimal cluster numbers to be plotted when n_clusters=&quot;auto&quot;.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    min_dist: float, optional (default: 0.25)</span>
<span class="sd">        A UMAP parameter</span>
<span class="sd">    n_neighbors: int, optinal (default: 15)</span>
<span class="sd">        A UMAP parameter.</span>
<span class="sd">    eps: Union[List[float], float], optional (default: 0.5)</span>
<span class="sd">        A DBSCAN parameter.</span>
<span class="sd">    pcacomponent: Optional[int]=None,</span>
<span class="sd">        The number of PCA component. PCA result will be used by UMAP and hierarchical clustering.</span>
<span class="sd">    ztranform: bool, optinal (default: True)</span>
<span class="sd">        Whether to convert data into z scores.</span>
<span class="sd">    palette: list, optional (default: [&quot;Spectral&quot;,&quot;cubehelix&quot;])</span>
<span class="sd">    </span>
<span class="sd">    save: str=&quot;&quot;,</span>
<span class="sd">    piesize_scale: float=0.02</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    
    
    <span class="n">original_index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span>
    
    <span class="n">X</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">_separate_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
    
    
    <span class="k">if</span> <span class="n">ztranform</span><span class="p">:</span>
        <span class="n">X</span><span class="o">=</span><span class="n">zscore</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">pcacomponent</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
            
        <span class="k">if</span> <span class="mi">20</span><span class="o">&lt;</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">pcacomponent</span><span class="o">=</span><span class="mi">20</span>
        <span class="k">elif</span> <span class="mi">10</span><span class="o">&lt;</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">pcacomponent</span><span class="o">=</span><span class="mi">10</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pcacomponent</span><span class="o">=</span><span class="mi">2</span>
    <span class="n">pca</span><span class="o">=</span><span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">pcacomponent</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">xpca</span><span class="o">=</span><span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">reduce_dimension</span><span class="o">==</span><span class="s2">&quot;umap&quot;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">umap</span>
        <span class="n">u</span><span class="o">=</span><span class="n">umap</span><span class="o">.</span><span class="n">UMAP</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_neighbors</span><span class="p">)</span>
        <span class="n">X</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">xpca</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">n_clusters</span><span class="o">==</span><span class="s2">&quot;auto&quot;</span> <span class="ow">and</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;kmeans&quot;</span><span class="p">:</span>
        <span class="n">Sum_of_squared_distances</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">K</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">testrange</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">K</span><span class="p">:</span>
            <span class="n">km</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">n_init</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">km</span> <span class="o">=</span> <span class="n">km</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">Sum_of_squared_distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">km</span><span class="o">.</span><span class="n">inertia_</span><span class="p">)</span>
        <span class="n">normy</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Sum_of_squared_distances</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">Sum_of_squared_distances</span><span class="p">)</span>
        <span class="n">normy</span><span class="o">=</span><span class="mi">1</span><span class="o">-</span><span class="n">normy</span>
        <span class="n">normx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">K</span><span class="p">))</span>
        <span class="n">perp</span><span class="o">=</span><span class="n">_calc_curveture</span><span class="p">(</span><span class="n">normx</span><span class="p">,</span> <span class="n">normy</span><span class="p">)</span>
        <span class="c1"># perp=[]</span>
        <span class="c1"># for i, (nx, ny) in enumerate(zip(normx, normy)):</span>
        <span class="c1">#     if i==0:</span>
        <span class="c1">#         perp.append(0)</span>
        <span class="c1">#         continue</span>
        <span class="c1">#     r=(nx**2+ny**2)**0.5</span>
        <span class="c1">#     sina=ny/r</span>
        <span class="c1">#     cosa=nx/r</span>
        <span class="c1">#     sinamb=sina*np.cos(np.pi*0.25)-cosa*np.sin(np.pi*0.25)</span>
        <span class="c1">#     perp.append(r*sinamb)</span>
        <span class="c1"># perp=np.array(perp)</span>
        <span class="n">srtindex</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">perp</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">Sum_of_squared_distances</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Sum of squared distances&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">perp</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">Sum_of_squared_distances</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;curveture&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">topn_cluster_num</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">K</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">K</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">Sum_of_squared_distances</span><span class="p">)],</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">K</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">Sum_of_squared_distances</span><span class="p">)</span><span class="o">*</span><span class="mf">0.95</span><span class="p">,</span> <span class="s2">&quot;N=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">K</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Cluster number&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Sum of squared distances&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Elbow method for optimal cluster number&#39;</span><span class="p">)</span>    
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="c1">#print(&quot;Top two optimal cluster No are: {}, {}&quot;.format(K[srtindex[0]],K[srtindex[1]]))</span>
        <span class="c1">#n_clusters=[K[srtindex[0]],K[srtindex[1]]]</span>
        <span class="n">n_clusters</span><span class="o">=</span><span class="p">[</span> <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">srtindex</span><span class="p">[:</span><span class="n">topn_cluster_num</span><span class="p">]]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top two optimal cluster No are:&quot;</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">)</span>
        <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n_clusters</span><span class="o">==</span><span class="s2">&quot;auto&quot;</span> <span class="ow">and</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;fuzzy&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">skfuzzy</span> <span class="k">as</span> <span class="nn">fuzz</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pip._internal</span> <span class="kn">import</span> <span class="n">main</span> <span class="k">as</span> <span class="n">pip</span>
            <span class="n">pip</span><span class="p">([</span><span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="s1">&#39;--user&#39;</span><span class="p">,</span> <span class="s1">&#39;scikit-fuzzy&#39;</span><span class="p">])</span>
            <span class="kn">import</span> <span class="nn">skfuzzy</span> <span class="k">as</span> <span class="nn">fuzz</span>
        <span class="n">fpcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">K</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">testrange</span><span class="p">))</span>
        <span class="n">_X</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">T</span>
        <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="n">K</span><span class="p">:</span>
            
            <span class="n">cntr</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">jm</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">fpc</span> <span class="o">=</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">cmeans</span><span class="p">(</span><span class="n">_X</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            
            <span class="n">fpcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fpc</span><span class="p">)</span>
        
        <span class="n">srtindex</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">fpcs</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">fpcs</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
     
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">topn_cluster_num</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">K</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">K</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">fpcs</span><span class="p">)],</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">K</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">fpcs</span><span class="p">)</span><span class="o">*</span><span class="mf">0.95</span><span class="p">,</span> <span class="s2">&quot;N=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">K</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Cluster number&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Fuzzy partition coefficient&#39;</span><span class="p">)</span>
        <span class="n">n_clusters</span><span class="o">=</span><span class="p">[</span> <span class="n">K</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">srtindex</span><span class="p">[:</span><span class="n">topn_cluster_num</span><span class="p">]]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top two optimal cluster No are:&quot;</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">)</span>
        
        
        <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n_clusters</span><span class="o">==</span><span class="s2">&quot;auto&quot;</span> <span class="ow">and</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;hierarchical&quot;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">scipy.spatial.distance</span> <span class="k">as</span> <span class="nn">ssd</span>
        
        <span class="n">labels</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span>
        <span class="n">D</span><span class="o">=</span><span class="n">ssd</span><span class="o">.</span><span class="n">squareform</span><span class="p">(</span><span class="n">ssd</span><span class="o">.</span><span class="n">pdist</span><span class="p">(</span><span class="n">xpca</span><span class="p">))</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">sch</span><span class="o">.</span><span class="n">linkage</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ward&#39;</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">sch</span><span class="o">.</span><span class="n">dendrogram</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span><span class="n">no_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">K</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">*</span><span class="n">testrange</span><span class="p">))</span>
        <span class="n">newK</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">scores</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">K</span><span class="p">:</span>
            <span class="n">t</span><span class="o">=</span><span class="n">_dendrogram_threshold</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="n">Z2</span><span class="o">=</span><span class="n">sch</span><span class="o">.</span><span class="n">dendrogram</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span>
                                <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">,</span>
                                <span class="n">color_threshold</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">no_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
            <span class="n">clusters</span><span class="o">=</span><span class="n">_get_cluster_classes</span><span class="p">(</span><span class="n">Z2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ivl&#39;</span><span class="p">)</span>
            <span class="n">_k</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">clusters</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_k</span> <span class="ow">in</span> <span class="n">newK</span><span class="p">:</span>
                <span class="n">newK</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_k</span><span class="p">)</span>
                <span class="n">sample2cluster</span><span class="o">=</span><span class="p">{}</span>
                <span class="n">i</span><span class="o">=</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                        <span class="n">sample2cluster</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">silhouette_score</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="p">[</span><span class="n">sample2cluster</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">],</span> <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;euclidean&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">_k</span><span class="p">)</span>

        <span class="n">scores</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        <span class="n">srtindex</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">scores</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">newK</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">topn_cluster_num</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">newK</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">newK</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">scores</span><span class="p">)],</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">newK</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="o">*</span><span class="mf">0.95</span><span class="p">,</span> <span class="s2">&quot;N=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">newK</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">newK</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Cluster number&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Silhouette scores&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Optimal cluster number searches by silhouette method&#39;</span><span class="p">)</span>    
        
        <span class="n">n_clusters</span><span class="o">=</span><span class="p">[</span> <span class="n">newK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">srtindex</span><span class="p">[:</span><span class="n">topn_cluster_num</span><span class="p">]]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top two optimal cluster No are:&quot;</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">)</span>
        <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">n_clusters</span><span class="o">==</span><span class="s2">&quot;auto&quot;</span> <span class="ow">and</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;dbscan&quot;</span><span class="p">:</span>

        <span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">NearestNeighbors</span>
        <span class="n">neigh</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">nbrs</span> <span class="o">=</span> <span class="n">neigh</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">nbrs</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">distances</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">K</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">distances</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">distances</span><span class="p">),</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">newK</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">scores</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">_K</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">K</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dbX</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dbX</span><span class="o">.</span><span class="n">labels_</span><span class="p">[</span><span class="n">dbX</span><span class="o">.</span><span class="n">labels_</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">])</span>
  
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">_k</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_k</span> <span class="ow">in</span> <span class="n">newK</span><span class="p">:</span>
                <span class="n">newK</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_k</span><span class="p">)</span>
                <span class="n">_K</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">silhouette_score</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">dbX</span><span class="o">.</span><span class="n">labels_</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">],</span> <span class="n">dbX</span><span class="o">.</span><span class="n">labels_</span><span class="p">[</span><span class="n">dbX</span><span class="o">.</span><span class="n">labels_</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">],</span> <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;euclidean&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">_k</span><span class="p">)</span>

        <span class="n">scores</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        
        <span class="n">_ksort</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">newK</span><span class="p">)</span>
        <span class="n">_K</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_K</span><span class="p">)[</span><span class="n">_ksort</span><span class="p">]</span>
        <span class="n">newK</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">newK</span><span class="p">)[</span><span class="n">_ksort</span><span class="p">]</span>
        <span class="n">scores</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scores</span><span class="p">)[</span><span class="n">_ksort</span><span class="p">]</span>
        <span class="n">srtindex</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">scores</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">newK</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">topn_cluster_num</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">_K</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">_K</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">scores</span><span class="p">)],</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">_K</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="o">*</span><span class="mf">0.95</span><span class="p">,</span> <span class="s2">&quot;N=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">newK</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">newK</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;eps&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Silhouette scores&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Optimal cluster number searches by silhouette method&#39;</span><span class="p">)</span>    

        <span class="n">_n_clusters</span><span class="o">=</span><span class="p">[</span> <span class="n">newK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">topn_cluster_num</span><span class="p">)]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top two optimal cluster No are:&quot;</span><span class="p">,</span> <span class="n">_n_clusters</span><span class="p">)</span>
        <span class="n">eps</span><span class="o">=</span><span class="p">[</span><span class="n">_K</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">srtindex</span><span class="p">[:</span><span class="n">topn_cluster_num</span><span class="p">]]</span>
        <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
        
    <span class="k">elif</span> <span class="n">n_clusters</span><span class="o">==</span><span class="s2">&quot;auto&quot;</span> <span class="ow">and</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;hdbscan&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">hdbscan</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pip._internal</span> <span class="kn">import</span> <span class="n">main</span> <span class="k">as</span> <span class="n">pip</span>
            <span class="n">pip</span><span class="p">([</span><span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="s1">&#39;--user&#39;</span><span class="p">,</span> <span class="s1">&#39;hdbscan&#39;</span><span class="p">])</span>
            <span class="kn">import</span> <span class="nn">hdbscan</span>
        
        <span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">NearestNeighbors</span>
        <span class="n">neigh</span> <span class="o">=</span> <span class="n">NearestNeighbors</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">nbrs</span> <span class="o">=</span> <span class="n">neigh</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">nbrs</span><span class="o">.</span><span class="n">kneighbors</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">distances</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">#K=np.linspace(0.01,1,10)</span>
        <span class="n">K</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
        <span class="n">newK</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">scores</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">_K</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">K</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">hdbscan</span><span class="o">.</span><span class="n">HDBSCAN</span><span class="p">(</span><span class="n">min_cluster_size</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> 
                                 <span class="c1">#cluster_selection_epsilon=k,</span>
                                 <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> 
                                 <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span><span class="n">leaf_size</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                                <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">core_dist_n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dbX</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dbX</span><span class="o">.</span><span class="n">labels_</span><span class="p">[</span><span class="n">dbX</span><span class="o">.</span><span class="n">labels_</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">])</span>
  
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">_k</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_k</span> <span class="ow">in</span> <span class="n">newK</span><span class="p">:</span>
                <span class="n">newK</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_k</span><span class="p">)</span>
                <span class="n">_K</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">silhouette_score</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">dbX</span><span class="o">.</span><span class="n">labels_</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">],</span> <span class="n">dbX</span><span class="o">.</span><span class="n">labels_</span><span class="p">[</span><span class="n">dbX</span><span class="o">.</span><span class="n">labels_</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">],</span> <span class="n">metric</span> <span class="o">=</span> <span class="s1">&#39;euclidean&#39;</span><span class="p">)</span><span class="o">/</span><span class="n">_k</span><span class="p">)</span>
        
        <span class="n">scores</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>
        
        <span class="n">_ksort</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">newK</span><span class="p">)</span>
        <span class="n">_K</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_K</span><span class="p">)[</span><span class="n">_ksort</span><span class="p">]</span>
        <span class="n">newK</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">newK</span><span class="p">)[</span><span class="n">_ksort</span><span class="p">]</span>
        <span class="n">scores</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">scores</span><span class="p">)[</span><span class="n">_ksort</span><span class="p">]</span>
        <span class="n">srtindex</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">scores</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">newK</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">topn_cluster_num</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">_K</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span><span class="n">_K</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]]],[</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">scores</span><span class="p">)],</span> <span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">_K</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span><span class="o">*</span><span class="mf">0.95</span><span class="p">,</span> <span class="s2">&quot;N=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">newK</span><span class="p">[</span><span class="n">srtindex</span><span class="p">[</span><span class="n">i</span><span class="p">]]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">_K</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;min_cluster_size&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Silhouette scores&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Optimal cluster number searches by silhouette method&#39;</span><span class="p">)</span>    

        <span class="n">_n_clusters</span><span class="o">=</span><span class="p">[</span> <span class="n">newK</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">topn_cluster_num</span><span class="p">)]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Top two optimal cluster No are:&quot;</span><span class="p">,</span> <span class="n">_n_clusters</span><span class="p">)</span>
        <span class="n">min_cluster_size</span><span class="o">=</span><span class="p">[</span><span class="n">_K</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">srtindex</span><span class="p">[:</span><span class="n">topn_cluster_num</span><span class="p">]]</span>
        <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n_clusters</span><span class="o">=</span><span class="p">[</span><span class="n">n_clusters</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;kmeans&quot;</span><span class="p">:</span>
        <span class="n">dfnews</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">if</span> <span class="n">reduce_dimension</span><span class="o">==</span><span class="s2">&quot;umap&quot;</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;UMAP1&quot;</span>
            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;UMAP2&quot;</span>
        <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="n">n_clusters</span><span class="p">:</span>
            <span class="n">kmean</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">nc</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">n_init</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">kmX</span><span class="o">=</span><span class="n">kmean</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">kmX</span><span class="o">.</span><span class="n">labels_</span><span class="p">)</span>
            
            <span class="n">dfnew</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">original_index</span><span class="p">)</span>
            <span class="n">dfnew</span><span class="p">[</span><span class="s2">&quot;kmeans&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">kmX</span><span class="o">.</span><span class="n">labels_</span>
            <span class="n">dfnews</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfnew</span><span class="p">)</span>
        <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;kmeans&quot;</span>
        
    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;hierarchical&quot;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">scipy.spatial.distance</span> <span class="k">as</span> <span class="nn">ssd</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span>
        <span class="n">D</span><span class="o">=</span><span class="n">ssd</span><span class="o">.</span><span class="n">squareform</span><span class="p">(</span><span class="n">ssd</span><span class="o">.</span><span class="n">pdist</span><span class="p">(</span><span class="n">xpca</span><span class="p">))</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">sch</span><span class="o">.</span><span class="n">linkage</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;ward&#39;</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">sch</span><span class="o">.</span><span class="n">dendrogram</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span><span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span><span class="n">no_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reduce_dimension</span><span class="o">==</span><span class="s2">&quot;umap&quot;</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;UMAP1&quot;</span>
            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;UMAP2&quot;</span>
        <span class="n">dfnews</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="n">n_clusters</span><span class="p">:</span>
            <span class="n">t</span><span class="o">=</span><span class="n">_dendrogram_threshold</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">nc</span><span class="p">)</span>
            <span class="n">Z2</span><span class="o">=</span><span class="n">sch</span><span class="o">.</span><span class="n">dendrogram</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span>
                                <span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span><span class="p">,</span>
                                <span class="n">color_threshold</span><span class="o">=</span><span class="n">t</span><span class="p">,</span><span class="n">no_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
            <span class="n">clusters</span><span class="o">=</span><span class="n">_get_cluster_classes</span><span class="p">(</span><span class="n">Z2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ivl&#39;</span><span class="p">)</span>
            <span class="n">sample2cluster</span><span class="o">=</span><span class="p">{}</span>
            <span class="n">i</span><span class="o">=</span><span class="mi">1</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">clusters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                    <span class="n">sample2cluster</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;C&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
                
            <span class="n">dfnew</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">original_index</span><span class="p">)</span>
            <span class="n">dfnew</span><span class="p">[</span><span class="s2">&quot;hierarchical&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">sample2cluster</span><span class="p">[</span><span class="n">sample</span><span class="p">]</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">]</span>       
            <span class="n">dfnews</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfnew</span><span class="p">)</span>
        <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;hierarchical&quot;</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;dbscan&quot;</span><span class="p">:</span>
        <span class="n">dfnews</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">if</span> <span class="n">reduce_dimension</span><span class="o">==</span><span class="s2">&quot;umap&quot;</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;UMAP1&quot;</span>
            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;UMAP2&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">eps</span><span class="p">)</span><span class="o">==</span><span class="nb">float</span><span class="p">:</span>
            <span class="n">eps</span><span class="o">=</span><span class="p">[</span><span class="n">eps</span><span class="p">]</span>
        <span class="n">n_clusters</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">eps</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">DBSCAN</span><span class="p">(</span><span class="n">eps</span><span class="o">=</span><span class="n">e</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dbX</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dbX</span><span class="o">.</span><span class="n">labels_</span><span class="p">)</span>
            
            <span class="n">dfnew</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">original_index</span><span class="p">)</span>
            <span class="n">dfnew</span><span class="p">[</span><span class="s2">&quot;dbscan&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">dbX</span><span class="o">.</span><span class="n">labels_</span>
            <span class="n">dfnews</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfnew</span><span class="p">)</span>
            <span class="n">tmp</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">dbX</span><span class="o">.</span><span class="n">labels_</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">n_clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;, eps=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
            
            
        <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;dbscan&quot;</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;hdbscan&quot;</span><span class="p">:</span>
        <span class="n">dfnews</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">if</span> <span class="n">reduce_dimension</span><span class="o">==</span><span class="s2">&quot;umap&quot;</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;UMAP1&quot;</span>
            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;UMAP2&quot;</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">hdbscan</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pip._internal</span> <span class="kn">import</span> <span class="n">main</span> <span class="k">as</span> <span class="n">pip</span>
            <span class="n">pip</span><span class="p">([</span><span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="s1">&#39;--user&#39;</span><span class="p">,</span> <span class="s1">&#39;hdbscan&#39;</span><span class="p">])</span>
            <span class="kn">import</span> <span class="nn">hdbscan</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">min_cluster_size</span><span class="p">)</span><span class="o">==</span><span class="nb">int</span><span class="p">:</span>
            <span class="n">min_cluster_size</span><span class="o">=</span><span class="p">[</span><span class="n">min_cluster_size</span><span class="p">]</span>
        <span class="n">n_clusters</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">fuzzylabels</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">min_cluster_size</span><span class="p">:</span>
            <span class="n">db</span> <span class="o">=</span> <span class="n">hdbscan</span><span class="o">.</span><span class="n">HDBSCAN</span><span class="p">(</span><span class="n">min_cluster_size</span><span class="o">=</span><span class="n">e</span><span class="p">,</span>
                                 <span class="n">prediction_data</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                 <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> 
                                 <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> 
                                 <span class="n">approx_min_span_tree</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">gen_min_span_tree</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">leaf_size</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span>
                                <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;euclidean&#39;</span><span class="p">,</span> <span class="n">min_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">dbX</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dbX</span><span class="o">.</span><span class="n">labels_</span><span class="p">)</span>
            
            <span class="n">dfnew</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">original_index</span><span class="p">)</span>
            <span class="n">dfnew</span><span class="p">[</span><span class="s2">&quot;dbscan&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">dbX</span><span class="o">.</span><span class="n">labels_</span>
            <span class="n">fuzzylabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hdbscan</span><span class="o">.</span><span class="n">all_points_membership_vectors</span><span class="p">(</span><span class="n">dbX</span><span class="p">))</span>
            <span class="n">dfnews</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfnew</span><span class="p">)</span>
            <span class="n">tmp</span><span class="o">=</span><span class="mi">0</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">dbX</span><span class="o">.</span><span class="n">labels_</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">tmp</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">n_clusters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;, eps=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
            
            
        <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;hdbscan&quot;</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;fuzzy&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">skfuzzy</span> <span class="k">as</span> <span class="nn">fuzz</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">pip._internal</span> <span class="kn">import</span> <span class="n">main</span> <span class="k">as</span> <span class="n">pip</span>
            <span class="n">pip</span><span class="p">([</span><span class="s1">&#39;install&#39;</span><span class="p">,</span> <span class="s1">&#39;--user&#39;</span><span class="p">,</span> <span class="s1">&#39;scikit-fuzzy&#39;</span><span class="p">])</span>
            <span class="kn">import</span> <span class="nn">skfuzzy</span> <span class="k">as</span> <span class="nn">fuzz</span>
        
        <span class="n">dfnews</span><span class="o">=</span><span class="p">[]</span>
        <span class="n">fuzzylabels</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">if</span> <span class="n">reduce_dimension</span><span class="o">==</span><span class="s2">&quot;umap&quot;</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;UMAP1&quot;</span>
            <span class="n">y</span><span class="o">=</span><span class="s2">&quot;UMAP2&quot;</span>
        <span class="n">_X</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">T</span>
        <span class="k">for</span> <span class="n">nc</span> <span class="ow">in</span> <span class="n">n_clusters</span><span class="p">:</span>
            
            <span class="n">cntr</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">u0</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">jm</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">fpc</span> <span class="o">=</span> <span class="n">fuzz</span><span class="o">.</span><span class="n">cmeans</span><span class="p">(</span><span class="n">_X</span><span class="p">,</span> <span class="n">nc</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            
            <span class="n">dfnew</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">original_index</span><span class="p">)</span>
            <span class="n">fuzzylabels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">dfnews</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfnew</span><span class="p">)</span>
        <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;fuzzy&quot;</span>
    

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">barrierfree</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">markers</span><span class="p">)</span><span class="o">==</span><span class="nb">bool</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">markers</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="n">barrierfree</span><span class="o">=</span><span class="kc">True</span>
                <span class="n">markers</span><span class="o">=</span><span class="n">maker_list</span> 
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">markers</span><span class="o">=</span><span class="p">[]</span>
                        
        <span class="n">lut</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">category</span><span class="p">):</span>
            <span class="n">_clut</span><span class="p">,</span> <span class="n">_mlut</span><span class="o">=</span><span class="n">_create_color_markerlut</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span><span class="n">palette</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">markers</span><span class="p">)</span>
            <span class="n">lut</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;colorlut&quot;</span><span class="p">:</span><span class="n">_clut</span><span class="p">,</span> <span class="s2">&quot;markerlut&quot;</span><span class="p">:</span><span class="n">_mlut</span><span class="p">}</span>
 
    <span class="n">_dfnews</span><span class="o">=</span><span class="p">{}</span>
    
    <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;fuzzy&quot;</span> <span class="ow">or</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;hdbscan&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">dfnew</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">fl</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dfnews</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">,</span> <span class="n">fuzzylabels</span><span class="p">):</span> 
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">=</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">),</span><span class="mi">4</span><span class="p">])</span>
            
            <span class="k">if</span> <span class="n">title</span><span class="o">!=</span><span class="s2">&quot;&quot;</span> <span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">K</span><span class="p">)</span><span class="o">==</span><span class="nb">str</span><span class="p">:</span>
                <span class="n">_K</span><span class="o">=</span><span class="n">K</span>
                <span class="n">K</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">_K</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
                <span class="n">K</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
                <span class="n">_cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">palette</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">K</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">palette</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">K</span><span class="p">)</span>
            <span class="n">colors</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">color_entropy</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">fl</span><span class="p">:</span>
                <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
                    <span class="c1">#print(_cmap(i))</span>
                    <span class="c1">#print(c[i])</span>
                    <span class="n">tmp</span><span class="o">+=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_cmap</span><span class="p">(</span><span class="n">i</span><span class="p">))[:</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">tmp</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tmp</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
                <span class="n">color_entropy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tmp</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">tmp</span><span class="o">+</span><span class="mf">0.000001</span><span class="p">)))</span>
                
            <span class="n">entropy_srt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">color_entropy</span><span class="p">)</span>
            <span class="n">colors</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">colors</span><span class="p">)[</span><span class="n">entropy_srt</span><span class="p">]</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">dfnew</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">entropy_srt</span><span class="p">],</span> <span class="n">dfnew</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">entropy_srt</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
            <span class="c1">#sns.scatterplot(data=dfnew,x=x,y=y,hue=hue, ax=ax[0], palette=palette[0],**kwargs)</span>
            <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;fuzzy&quot;</span><span class="p">:</span>
                <span class="n">_title</span><span class="o">=</span><span class="s2">&quot;Fuzzy c-means. Cluster num=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;hdbscan&quot;</span><span class="p">:</span>
                <span class="n">_title</span><span class="o">=</span><span class="s2">&quot;HDBSCAN. Cluster num=&quot;</span><span class="o">+</span><span class="n">_K</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">_title</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lavender&#39;</span><span class="p">,</span> 
                                      <span class="n">label</span><span class="o">=</span><span class="n">method</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                                      <span class="n">markerfacecolor</span><span class="o">=</span><span class="n">_cmap</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> 
                                      <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">)]</span>
    
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
                <span class="n">dfnew</span><span class="p">[</span><span class="n">method</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)]</span><span class="o">=</span><span class="n">fl</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span>
            
            <span class="n">pie_scatter</span><span class="p">(</span><span class="n">dfnew</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> 
                        <span class="n">category</span><span class="o">=</span><span class="p">[</span><span class="n">method</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">)],</span>
                        <span class="n">piesize_scale</span><span class="o">=</span><span class="n">piesize_scale</span><span class="p">,</span> 
                        <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Probability is represented by pie charts&quot;</span><span class="p">)</span>
            
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">category</span><span class="p">):</span>
                    <span class="n">dfnew</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span>
                    <span class="c1">#sns.scatterplot(data=dfnew,x=x,y=y,hue=cat, ax=ax[i+2], palette=palette[1], s=size,**kwargs)</span>
                    <span class="k">if</span> <span class="n">barrierfree</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                        
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">lut</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;colorlut&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">_dfnew</span><span class="o">=</span><span class="n">dfnew</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dfnew</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">==</span><span class="n">key</span><span class="p">]</span>
                            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">_dfnew</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">_dfnew</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">lut</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;colorlut&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="n">lut</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;markerlut&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
                        
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">lut</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;colorlut&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">_dfnew</span><span class="o">=</span><span class="n">dfnew</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dfnew</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">==</span><span class="n">key</span><span class="p">]</span>
                            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">_dfnew</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">_dfnew</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">lut</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;colorlut&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>



            <span class="n">_dfnews</span><span class="p">[</span><span class="n">K</span><span class="p">]</span><span class="o">=</span><span class="n">dfnew</span> 
    <span class="k">else</span><span class="p">:</span>
        
        
        
            
        <span class="k">for</span> <span class="n">dfnew</span><span class="p">,</span> <span class="n">K</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dfnews</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">):</span> 
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">axnum</span><span class="o">=</span><span class="mi">1</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">=</span><span class="p">[</span><span class="n">ax</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">),</span><span class="mi">4</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">title</span><span class="o">!=</span><span class="s2">&quot;&quot;</span> <span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">barrierfree</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="n">_clut</span><span class="p">,</span> <span class="n">_mlut</span><span class="o">=</span><span class="n">_create_color_markerlut</span><span class="p">(</span><span class="n">dfnew</span><span class="p">,</span> <span class="n">hue</span><span class="p">,</span><span class="n">palette</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">markers</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_clut</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">_dfnew</span><span class="o">=</span><span class="n">dfnew</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dfnew</span><span class="p">[</span><span class="n">hue</span><span class="p">]</span><span class="o">==</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">_dfnew</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">_dfnew</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">_clut</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="n">_mlut</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                
                <span class="n">_clut</span><span class="p">,</span> <span class="n">_mlut</span><span class="o">=</span><span class="n">_create_color_markerlut</span><span class="p">(</span><span class="n">dfnew</span><span class="p">,</span> <span class="n">hue</span><span class="p">,</span><span class="n">palette</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">markers</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">_clut</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">_dfnew</span><span class="o">=</span><span class="n">dfnew</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dfnew</span><span class="p">[</span><span class="n">hue</span><span class="p">]</span><span class="o">==</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">_dfnew</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">_dfnew</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">_clut</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
                    
                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">method</span><span class="o">+</span><span class="s2">&quot; Cluster number=&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">K</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">category</span><span class="p">):</span>
                    <span class="n">dfnew</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">barrierfree</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                        
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">lut</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;colorlut&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">_dfnew</span><span class="o">=</span><span class="n">dfnew</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dfnew</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">==</span><span class="n">key</span><span class="p">]</span>
                            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">_dfnew</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">_dfnew</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">lut</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;colorlut&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="n">lut</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;markerlut&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
                        
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">lut</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;colorlut&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">_dfnew</span><span class="o">=</span><span class="n">dfnew</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dfnew</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">==</span><span class="n">key</span><span class="p">]</span>
                            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">_dfnew</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">_dfnew</span><span class="p">[</span><span class="n">y</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">lut</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;colorlut&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
                        
            <span class="n">_dfnews</span><span class="p">[</span><span class="n">K</span><span class="p">]</span><span class="o">=</span><span class="n">dfnew</span>
    <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">method</span><span class="o">+</span><span class="s2">&quot;_scatter&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">_dfnews</span><span class="p">,</span> <span class="s2">&quot;axes&quot;</span><span class="p">:</span><span class="n">ax</span><span class="p">}</span></div>


<div class="viewcode-block" id="pie_scatter"><a class="viewcode-back" href="../../omniplot.html#omniplot.scatter.pie_scatter">[docs]</a><span class="k">def</span> <span class="nf">pie_scatter</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>  
                <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                <span class="n">y</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                <span class="n">category</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> 
                
                <span class="n">logscalex</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">logscaley</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">pie_palette</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;tab20c&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span>
                <span class="n">topn</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">piesizes</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">save</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">edge_color</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
                <span class="n">min_piesize</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                <span class="n">figsize</span><span class="p">:</span> <span class="nb">list</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span>
                <span class="n">xunit</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">yunit</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">xlabel</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">ylabel</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> 
                <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                
                <span class="n">bbox_to_anchor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mf">0.95</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">piesize_scale</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Drawing a scatter plot of which points are represented by pie charts. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas DataFrame</span>
<span class="sd">        A wide form dataframe. Index names are used to label points</span>
<span class="sd">        e.g.) </span>
<span class="sd">                    gas    coal    nuclear    population    GDP</span>
<span class="sd">            USA      20      20          5            20     50</span>
<span class="sd">            China    30      40          5            40     50</span>
<span class="sd">            India     5      10          1            40     10</span>
<span class="sd">            Japan     5       5          1            10     10</span>
<span class="sd">            </span>
<span class="sd">    x,y : str</span>
<span class="sd">        the names of columns to be x and y axes of the scatter plot.</span>
<span class="sd">        e.g.)</span>
<span class="sd">            x=&quot;population&quot;, y=&quot;GDP&quot;</span>
<span class="sd">        </span>
<span class="sd">    category: str or list</span>
<span class="sd">        the names of categorical values to display as pie charts</span>
<span class="sd">        e.g.)</span>
<span class="sd">            category=[&quot;gas&quot;, &quot;coal&quot;, &quot;nuclear&quot;]</span>
<span class="sd">    pie_palette : str</span>
<span class="sd">        A colormap name</span>
<span class="sd">    xlabel: str, optional</span>
<span class="sd">        x axis label</span>
<span class="sd">    ylabel: str, optional</span>
<span class="sd">        y axis label</span>
<span class="sd">    piesize: float, optional (default: 0.01) </span>
<span class="sd">        pie chart size. </span>
<span class="sd">    label: str, optional (default: &quot;all&quot;)</span>
<span class="sd">        &quot;all&quot;: all </span>
<span class="sd">        &quot;topn_of_sum&quot;: top n samples are labeled</span>
<span class="sd">        &quot;&quot;: no labels</span>
<span class="sd">    logscalex, logscaley: bool, optional (default: False)</span>
<span class="sd">        Whether to scale x an y axes with logarithm</span>
<span class="sd">    ax: Optional[plt.Axes] optional, (default: None)</span>
<span class="sd">        pyplot ax to add this scatter plot</span>
<span class="sd">    sizes: Union[List, str], optional (default: &quot;&quot;)</span>
<span class="sd">        pie chart sizes.</span>
<span class="sd">            &quot;sum_of_each&quot;: automatically set pie chart sizes to be proportional to the sum of all categories.</span>
<span class="sd">            list: the list of pie chart sizes</span>
<span class="sd">    edge_color: str=&quot;gray&quot;,</span>
<span class="sd">        The pie chart edge color</span>
<span class="sd">    min_piesize: float, optional (default: 0.3)</span>
<span class="sd">        Minimal pie chart size. This option is effective when the option sizes=&quot;sum_of_each&quot;. </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">    </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">pie_palette</span><span class="p">)</span><span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">colors</span><span class="o">=</span><span class="p">{}</span>
        <span class="n">unique_labels</span><span class="o">=</span><span class="n">category</span>
            
        <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">pie_palette</span><span class="p">)</span>
        <span class="n">labelnum</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ul</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_labels</span><span class="p">):</span>
            <span class="n">colors</span><span class="p">[</span><span class="n">ul</span><span class="p">]</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">labelnum</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">pie_palette</span><span class="p">)</span><span class="o">==</span><span class="nb">dict</span><span class="p">:</span>
        <span class="n">colors</span><span class="o">=</span><span class="n">pie_palette</span>
        <span class="n">unique_labels</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unknown pie_palette type.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">right</span><span class="o">=</span><span class="mf">0.80</span><span class="p">)</span>
    <span class="n">X</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
    <span class="n">Y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
    <span class="n">yscale</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="n">xscale</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">logscaley</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">Y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Y</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">yscale</span><span class="o">=</span><span class="s2">&quot; (scaled by log10)&quot;</span>
    <span class="k">if</span> <span class="n">logscalex</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">X</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">xscale</span><span class="o">=</span><span class="s2">&quot; (scaled by log10)&quot;</span>
    <span class="n">Frac</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">category</span><span class="p">]</span>
    
    <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="n">piesize_scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">Y</span><span class="p">)])</span><span class="o">*</span><span class="n">piesize_scale</span>
    
    <span class="k">if</span> <span class="n">piesizes</span><span class="o">==</span><span class="s2">&quot;sum_of_each&quot;</span><span class="p">:</span>
        <span class="n">sums</span><span class="o">=</span><span class="n">Frac</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sumsrt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">sums</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sumsrt</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="n">sumsrt</span><span class="p">[:</span><span class="n">topn</span><span class="p">])</span>
        <span class="n">sums</span><span class="o">=</span><span class="n">sums</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">sums</span><span class="p">)</span>
        <span class="n">sums</span><span class="o">=</span><span class="n">piesize_scale</span><span class="o">*</span><span class="p">(</span><span class="n">sums</span><span class="o">+</span><span class="n">min_piesize</span><span class="p">)</span>
    <span class="n">_colors</span><span class="o">=</span><span class="p">[</span><span class="n">colors</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">_ind</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">index</span><span class="p">)):</span>
        <span class="n">_frac</span><span class="o">=</span><span class="n">Frac</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">_ind</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> 
        <span class="n">_frac</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_frac</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">_frac</span><span class="p">)</span>
        
        <span class="n">angle</span><span class="o">=</span><span class="mi">0</span>
        <span class="c1">#print(sums.loc[_ind])</span>
        <span class="k">for</span> <span class="n">fr</span><span class="p">,</span> <span class="n">co</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">_frac</span><span class="p">,</span> <span class="n">_colors</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">piesizes</span><span class="p">)</span><span class="o">==</span><span class="nb">str</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">piesizes</span><span class="o">==</span><span class="s2">&quot;sum_of_each&quot;</span><span class="p">:</span>
                    <span class="n">_baumkuchen_xy</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sums</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">_ind</span><span class="p">],</span><span class="mi">20</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="n">edge_color</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">piesizes</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                    <span class="n">_baumkuchen_xy</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">piesize_scale</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="n">edge_color</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">piesizes</span><span class="p">)</span><span class="o">==</span><span class="nb">list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">piesizes</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">_baumkuchen_xy</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">piesize_scale</span><span class="o">*</span><span class="n">piesizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">20</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="n">edge_color</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_baumkuchen_xy</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">fr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">piesize_scale</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="n">edge_color</span><span class="p">)</span>
            <span class="n">angle</span><span class="o">+=</span><span class="n">fr</span>
        
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="o">==</span><span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">label</span><span class="o">==</span><span class="s2">&quot;all&quot;</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span><span class="n">_ind</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">label</span><span class="o">==</span><span class="s2">&quot;topn_of_sum&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sumsrt</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span><span class="n">_ind</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="n">label</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">label</span><span class="p">)</span><span class="o">==</span><span class="nb">list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_ind</span> <span class="ow">in</span> <span class="n">label</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">_y</span><span class="p">,</span><span class="n">_ind</span><span class="p">)</span>
            
            
    <span class="k">if</span> <span class="n">xlabel</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">x</span><span class="o">=</span><span class="n">xlabel</span>
    <span class="k">if</span> <span class="n">ylabel</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">y</span><span class="o">=</span><span class="n">ylabel</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">xscale</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">yscale</span><span class="p">)</span>
    <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lavender&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">ul</span><span class="p">,</span><span class="n">markerfacecolor</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">ul</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">ul</span> <span class="ow">in</span> <span class="n">unique_labels</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="p">)</span><span class="o">==</span><span class="nb">str</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span><span class="n">loc</span><span class="o">=</span><span class="n">bbox_to_anchor</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="n">bbox_to_anchor</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">yunit</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">yunit</span><span class="p">),</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">xunit</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;(</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xunit</span><span class="p">),</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span><span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">)</span>
    <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="s2">&quot;pie_scatter&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">show</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;axes&quot;</span><span class="p">:</span><span class="n">ax</span><span class="p">}</span></div>



<div class="viewcode-block" id="decomplot"><a class="viewcode-back" href="../../omniplot.html#omniplot.scatter.decomplot">[docs]</a><span class="k">def</span> <span class="nf">decomplot</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
              <span class="n">variables</span><span class="p">:</span> <span class="n">List</span><span class="o">=</span><span class="p">[],</span>
              <span class="n">category</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> 
              <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;pca&quot;</span><span class="p">,</span> 
              <span class="n">component</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
              <span class="n">arrow_color</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span>
              <span class="n">arrow_text_color</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
              <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
              <span class="n">explained_variance</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">arrow_num</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
              <span class="n">figsize</span><span class="o">=</span><span class="p">[],</span>
              <span class="n">regularization</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
              <span class="n">pcapram</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;random_state&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">},</span>
              <span class="n">nmfparam</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;random_state&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">},</span>
              <span class="n">save</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
              <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
              <span class="n">markers</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
              <span class="n">saveparam</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="p">{},</span>
              <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">palette</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;tab20b&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decomposing data and drawing a scatter plot and some plots for explained variables. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas DataFrame</span>
<span class="sd">    </span>
<span class="sd">    category: str</span>
<span class="sd">        the column name of a known sample category (if exists). </span>
<span class="sd">    variables: list, optional</span>
<span class="sd">        The names of variables to calculate decomposition.</span>
<span class="sd">    method: str</span>
<span class="sd">        Method name for decomposition. Available methods: [&quot;pca&quot;, &quot;nmf&quot;]</span>
<span class="sd">    component: int</span>
<span class="sd">        The component number</span>
<span class="sd">    </span>
<span class="sd">    show : bool</span>
<span class="sd">        Whether or not to show the figure.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        dict {&quot;data&quot;: dfpc_list,&quot;pca&quot;: pca, &quot;axes&quot;:axes, &quot;axes_explained&quot;:ax2} for pca method</span>
<span class="sd">        or {&quot;data&quot;: dfpc_list, &quot;W&quot;:W, &quot;H&quot;:H,&quot;axes&quot;:axes,&quot;axes_explained&quot;:axes2} for nmf method</span>
<span class="sd">            </span>
<span class="sd">    </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">_separate_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
    <span class="c1"># if category !=&quot;&quot;:</span>
    <span class="c1">#     category_val=df[category].values</span>
    <span class="c1">#     df=df.drop([category], axis=1)</span>
    <span class="c1">#     x = df.values</span>
    <span class="c1">#     assert x.dtype==float, f&quot;data must contain only float values except {category} column.&quot;</span>
    <span class="c1">#</span>
    <span class="c1"># else:    </span>
    <span class="c1">#     x = df.values</span>
    <span class="c1">#     assert x.dtype==float, &quot;data must contain only float values.&quot;</span>
    <span class="n">original_index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">features</span><span class="o">=</span><span class="n">variables</span>
    <span class="k">else</span><span class="p">:</span>
        
        <span class="n">features</span><span class="o">=</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">category</span><span class="p">)))</span>
    <span class="n">dfpc_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">comb</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">component</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
    

                    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">barrierfree</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">markers</span><span class="p">)</span><span class="o">==</span><span class="nb">bool</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">markers</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                <span class="n">barrierfree</span><span class="o">=</span><span class="kc">True</span>
                <span class="n">markers</span><span class="o">=</span><span class="n">maker_list</span> 
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">markers</span><span class="o">=</span><span class="p">[]</span>
                        
        <span class="n">lut</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">category</span><span class="p">):</span>
            <span class="n">_clut</span><span class="p">,</span> <span class="n">_mlut</span><span class="o">=</span><span class="n">_create_color_markerlut</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span><span class="n">palette</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">markers</span><span class="p">)</span>
            <span class="n">lut</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;colorlut&quot;</span><span class="p">:</span><span class="n">_clut</span><span class="p">,</span> <span class="s2">&quot;markerlut&quot;</span><span class="p">:</span><span class="n">_mlut</span><span class="p">}</span>


    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">figures</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">category</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comb</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
                <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">axes</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">comb</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comb</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">figsize</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">nrows</span><span class="p">]</span>
                
                <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
                <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">figures</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fig&quot;</span><span class="p">:</span> <span class="n">fig</span><span class="p">,</span> <span class="s2">&quot;axes&quot;</span><span class="p">:</span><span class="n">axes</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">figures</span><span class="o">=</span><span class="p">{}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">comb</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="n">axes</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">comb</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">comb</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">figsize</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="mi">3</span><span class="o">*</span><span class="n">nrows</span><span class="p">]</span>
            
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="n">nrows</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">right</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">figures</span><span class="p">[</span><span class="s2">&quot;nocat&quot;</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fig&quot;</span><span class="p">:</span> <span class="n">fig</span><span class="p">,</span> <span class="s2">&quot;axes&quot;</span><span class="p">:</span><span class="n">axes</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;pca&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">regularization</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="n">zscore</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">component</span><span class="p">,</span><span class="o">**</span><span class="n">pcapram</span><span class="p">)</span>
        <span class="n">pccomp</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">loadings</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_</span><span class="p">)</span>
        <span class="n">combnum</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">axi</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">comb</span><span class="p">):</span>
            <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;pc&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;pc&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dfpc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pccomp</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">pccomp</span><span class="p">[:,</span><span class="n">j</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">],</span><span class="n">index</span><span class="o">=</span><span class="n">original_index</span><span class="p">)</span>
            <span class="n">_loadings</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">loadings</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">loadings</span><span class="p">[:,</span><span class="n">j</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">_loadings</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">srtindx</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">a</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="n">arrow_num</span><span class="p">]</span>
            <span class="n">_loadings</span><span class="o">=</span><span class="n">_loadings</span><span class="p">[</span><span class="n">srtindx</span><span class="p">]</span>
            <span class="n">_features</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">features</span><span class="p">)[</span><span class="n">srtindx</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">category</span><span class="p">:</span>
                    <span class="n">dfpc</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">combnum</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dfpc</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">cat</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">figures</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;axes&quot;</span><span class="p">][</span><span class="n">axi</span><span class="p">],</span><span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">)</span>
                        <span class="n">figures</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;axes&quot;</span><span class="p">][</span><span class="n">axi</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dfpc</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">cat</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">figures</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;axes&quot;</span><span class="p">][</span><span class="n">axi</span><span class="p">],</span>
                                        <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_features</span><span class="p">):</span>
                        <span class="n">figures</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;axes&quot;</span><span class="p">][</span><span class="n">axi</span><span class="p">]</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_loadings</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span><span class="n">_loadings</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">arrow_color</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span><span class="n">head_width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
                        <span class="n">figures</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;axes&quot;</span><span class="p">][</span><span class="n">axi</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">_loadings</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span><span class="n">_loadings</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="n">feature</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">arrow_text_color</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dfpc</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">figures</span><span class="p">[</span><span class="s2">&quot;nocat&quot;</span><span class="p">][</span><span class="n">axi</span><span class="p">],</span><span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">)</span>
            
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_features</span><span class="p">):</span>
                    <span class="c1">#ax.plot([0,_loadings[k, 0] ], [0,_loadings[k, 1] ],color=arrow_color)</span>
                    <span class="n">figures</span><span class="p">[</span><span class="s2">&quot;nocat&quot;</span><span class="p">][</span><span class="n">axi</span><span class="p">]</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_loadings</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span><span class="n">_loadings</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">arrow_color</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span><span class="n">head_width</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
                    <span class="n">figures</span><span class="p">[</span><span class="s2">&quot;nocat&quot;</span><span class="p">][</span><span class="n">axi</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">_loadings</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span><span class="n">_loadings</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="n">feature</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">arrow_text_color</span><span class="p">)</span>
    
            <span class="n">dfpc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfpc</span><span class="p">)</span>
            <span class="n">combnum</span><span class="o">+=</span><span class="mi">1</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">category</span><span class="p">:</span>
                <span class="n">figures</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;fig&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
                <span class="n">figures</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;fig&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">cat</span><span class="o">+</span><span class="s2">&quot;_PCA&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">figures</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;fig&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">figures</span><span class="p">[</span><span class="s2">&quot;nocat&quot;</span><span class="p">][</span><span class="s2">&quot;fig&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="n">figures</span><span class="p">[</span><span class="s2">&quot;nocat&quot;</span><span class="p">][</span><span class="s2">&quot;fig&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="s2">&quot;PCA&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">explained_variance</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax2</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">exp_var_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span>
            <span class="c1">#</span>
            <span class="c1"># Cumulative sum of eigenvalues; This will be used to create step plot</span>
            <span class="c1"># for visualizing the variance explained by each principal component.</span>
            <span class="c1">#</span>
            <span class="n">cum_sum_eigenvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">exp_var_pca</span><span class="p">)</span>
            <span class="c1">#</span>
            <span class="c1"># Create the visualization plot</span>
            <span class="c1">#</span>
            <span class="n">xlabel</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;pc&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">exp_var_pca</span><span class="p">))]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">exp_var_pca</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Individual explained variance&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">cum_sum_eigenvalues</span><span class="p">)),</span> <span class="n">cum_sum_eigenvalues</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Cumulative explained variance&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Explained variance ratio&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Principal component index&#39;</span><span class="p">)</span>
            <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="s2">&quot;ExplainedVar&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax2</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="n">show</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">dfpc_list</span><span class="p">,</span><span class="s2">&quot;pca&quot;</span><span class="p">:</span> <span class="n">pca</span><span class="p">,</span> <span class="s2">&quot;axes&quot;</span><span class="p">:</span><span class="n">figures</span><span class="p">,</span> <span class="s2">&quot;axes_explained&quot;</span><span class="p">:</span><span class="n">ax2</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;nmf&quot;</span><span class="p">:</span>
        <span class="n">nmf</span><span class="o">=</span><span class="n">NMF</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">component</span><span class="p">,</span><span class="o">**</span><span class="n">nmfparam</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">regularization</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="kc">None</span><span class="p">,:]</span>
        <span class="n">W</span> <span class="o">=</span> <span class="n">nmf</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">nmf</span><span class="o">.</span><span class="n">components_</span>
        <span class="n">combnum</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">axi</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">comb</span><span class="p">):</span>
            <span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;p&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;p&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dfpc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">W</span><span class="p">[:,</span><span class="n">i</span><span class="p">],</span><span class="n">W</span><span class="p">[:,</span><span class="n">j</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">],</span><span class="n">index</span><span class="o">=</span><span class="n">original_index</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">category</span><span class="p">:</span>
                    <span class="n">dfpc</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">combnum</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dfpc</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">cat</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">figures</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;axes&quot;</span><span class="p">][</span><span class="n">axi</span><span class="p">],</span><span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">)</span>
                        <span class="n">figures</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;axes&quot;</span><span class="p">][</span><span class="n">axi</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.02</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dfpc</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">cat</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">figures</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;axes&quot;</span><span class="p">][</span><span class="n">axi</span><span class="p">],</span>
                                        <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dfpc</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">xlabel</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ylabel</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">category</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">figures</span><span class="p">[</span><span class="s2">&quot;nocat&quot;</span><span class="p">][</span><span class="n">axi</span><span class="p">],</span><span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">)</span>
            <span class="n">dfpc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfpc</span><span class="p">)</span>
            <span class="n">combnum</span><span class="o">+=</span><span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">category</span><span class="p">:</span>
                <span class="n">figures</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;fig&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
                <span class="n">figures</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;fig&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">cat</span><span class="o">+</span><span class="s2">&quot;_NMF&quot;</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">figures</span><span class="p">[</span><span class="n">cat</span><span class="p">][</span><span class="s2">&quot;fig&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">figures</span><span class="p">[</span><span class="s2">&quot;nocat&quot;</span><span class="p">][</span><span class="s2">&quot;fig&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="n">figures</span><span class="p">[</span><span class="s2">&quot;nocat&quot;</span><span class="p">][</span><span class="s2">&quot;fig&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="s2">&quot;NMF&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">explained_variance</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes2</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="n">component</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">axes2</span><span class="o">=</span><span class="n">axes2</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes2</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Coefficients of matrix H&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)),</span><span class="n">H</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)),</span><span class="n">labels</span><span class="o">=</span><span class="p">[])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features</span><span class="p">)),</span><span class="n">labels</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            
            <span class="c1"># dfw={&quot;index&quot;:[],&quot;p&quot;:[],&quot;val&quot;:[]}</span>
            <span class="c1"># ps=[&quot;p&quot;+str(i+1) for i in range(component)]</span>
            <span class="c1"># originalindex=df.index</span>
            <span class="c1"># for i in range(W.shape[0]):</span>
            <span class="c1">#     for j in range(W.shape[1]):</span>
            <span class="c1">#         dfw[&quot;index&quot;].append(originalindex[i])</span>
            <span class="c1">#         dfw[&quot;p&quot;].append(ps[j])</span>
            <span class="c1">#         dfw[&quot;val&quot;].append(W[i,j])</span>
            <span class="c1"># dfw=pd.DataFrame(data=dfw)</span>
            <span class="c1">#</span>
            <span class="c1"># dfh={&quot;feature&quot;:[],&quot;p&quot;:[],&quot;val&quot;:[]}</span>
            <span class="c1"># for i in range(H.shape[0]):</span>
            <span class="c1">#     for j in range(H.shape[1]):</span>
            <span class="c1">#         dfh[&quot;p&quot;].append(ps[i])</span>
            <span class="c1">#         dfh[&quot;feature&quot;].append(features[j])</span>
            <span class="c1">#</span>
            <span class="c1">#         dfh[&quot;val&quot;].append(H[i,j])</span>
            <span class="c1"># dfw=pd.DataFrame(data=dfw)</span>
            <span class="c1"># dfh=pd.DataFrame(data=dfh)</span>
            <span class="c1"># #dotplot(dfw,row=&quot;index&quot;,col=&quot;p&quot;,size_val=&quot;val&quot;)</span>
            <span class="c1"># dotplot(dfh,row=&quot;p&quot;,col=&quot;feature&quot;,size_val=&quot;val&quot;,)</span>
            <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="s2">&quot;Coefficients&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axes2</span><span class="o">=</span><span class="kc">None</span>
        <span class="k">if</span> <span class="n">show</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">dfpc_list</span><span class="p">,</span> <span class="s2">&quot;W&quot;</span><span class="p">:</span><span class="n">W</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span><span class="p">:</span><span class="n">H</span><span class="p">,</span><span class="s2">&quot;axes&quot;</span><span class="p">:</span><span class="n">figures</span><span class="p">,</span><span class="s2">&quot;axes_explained&quot;</span><span class="p">:</span><span class="n">axes2</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;lda&quot;</span><span class="p">:</span>
        <span class="n">lda</span><span class="o">=</span><span class="n">LatentDirichletAllocation</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">component</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">regularization</span><span class="p">:</span>
            <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="kc">None</span><span class="p">,:]</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is not in options. Available options are: pca, nmf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span></div>


<div class="viewcode-block" id="manifoldplot"><a class="viewcode-back" href="../../omniplot.html#omniplot.scatter.manifoldplot">[docs]</a><span class="k">def</span> <span class="nf">manifoldplot</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                 <span class="n">variables</span><span class="p">:</span> <span class="n">List</span><span class="o">=</span><span class="p">[],</span>
                 <span class="n">category</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> 
                 <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;tsne&quot;</span><span class="p">,</span>
                 <span class="n">show</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>
                 <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                 <span class="n">param</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">save</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">palette</span><span class="o">=</span><span class="s2">&quot;tab20c&quot;</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reducing the dimensionality of data and drawing a scatter plot. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas DataFrame</span>
<span class="sd">    category: list or str, optional</span>
<span class="sd">        the column name of a known sample category (if exists). </span>
<span class="sd">    method: str</span>
<span class="sd">        Method name for decomposition. </span>
<span class="sd">        Available methods: {&quot;random_projection&quot;: &quot;Sparse random projection&quot;,</span>
<span class="sd">                            &quot;linear_discriminant&quot;: &quot;Linear discriminant analysis&quot;,</span>
<span class="sd">                            &quot;isomap&quot;: &quot;Isomap&quot;,</span>
<span class="sd">                            &quot;lle&quot;: &quot;Locally linear embedding&quot;,</span>
<span class="sd">                            &quot;modlle&quot;: &quot;Modified locally linear embedding&quot;,</span>
<span class="sd">                            &quot;hessian_lle&quot;:&quot; Hessian locally linear embedding&quot;,</span>
<span class="sd">                            &quot;ltsa_lle&quot;: &quot;LTSA&quot;,</span>
<span class="sd">                            &quot;mds&quot;: &quot;MDS&quot;,</span>
<span class="sd">                            &quot;random_trees&quot;: &quot;Random Trees Embedding&quot;,</span>
<span class="sd">                            &quot;spectral&quot;: &quot;Spectral embedding&quot;,</span>
<span class="sd">                            &quot;tsne&quot;: &quot;TSNE&quot;,</span>
<span class="sd">                            &quot;nca&quot;: &quot;Neighborhood components analysis&quot;,</span>
<span class="sd">                            &quot;umap&quot;:&quot;UMAP&quot;}</span>
<span class="sd">    component: int</span>
<span class="sd">        The number of components</span>
<span class="sd">    n_neighbors: int</span>
<span class="sd">        The number of neighbors related to isomap and lle methods.</span>
<span class="sd">    </span>
<span class="sd">    show : bool</span>
<span class="sd">        Whether or not to show the figure.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">method_dict</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;random_projection&quot;</span><span class="p">:</span> <span class="s2">&quot;Sparse random projection&quot;</span><span class="p">,</span>
    <span class="s2">&quot;linear_discriminant&quot;</span><span class="p">:</span> <span class="s2">&quot;Linear discriminant analysis&quot;</span><span class="p">,</span>
    <span class="s2">&quot;isomap&quot;</span><span class="p">:</span> <span class="s2">&quot;Isomap&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lle&quot;</span><span class="p">:</span> <span class="s2">&quot;Locally linear embedding&quot;</span><span class="p">,</span>
    <span class="s2">&quot;modlle&quot;</span><span class="p">:</span> <span class="s2">&quot;Modified locally linear embedding&quot;</span><span class="p">,</span>
    <span class="s2">&quot;hessian_lle&quot;</span><span class="p">:</span><span class="s2">&quot; Hessian locally linear embedding&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ltsa_lle&quot;</span><span class="p">:</span> <span class="s2">&quot;LTSA&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mds&quot;</span><span class="p">:</span> <span class="s2">&quot;MDS&quot;</span><span class="p">,</span>
    <span class="s2">&quot;random_trees&quot;</span><span class="p">:</span> <span class="s2">&quot;Random Trees Embedding&quot;</span><span class="p">,</span>
    <span class="s2">&quot;spectral&quot;</span><span class="p">:</span> <span class="s2">&quot;Spectral embedding&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tsne&quot;</span><span class="p">:</span> <span class="s2">&quot;TSNE&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nca&quot;</span><span class="p">:</span> <span class="s2">&quot;Neighborhood components analysis&quot;</span><span class="p">,</span>
    <span class="s2">&quot;umap&quot;</span><span class="p">:</span><span class="s2">&quot;UMAP&quot;</span><span class="p">}</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">_separate_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">variables</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
   
    <span class="n">x</span><span class="o">=</span><span class="n">zscore</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">features</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span>
    <span class="n">original_index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="n">embedding</span><span class="o">=</span><span class="n">_get_embedding</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span><span class="n">param</span><span class="o">=</span><span class="n">param</span><span class="p">)</span>
    <span class="n">Xt</span><span class="o">=</span><span class="n">embedding</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">dft</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">Xt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">Xt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;d1&quot;</span><span class="p">,</span> <span class="s2">&quot;d2&quot;</span><span class="p">],</span><span class="n">index</span><span class="o">=</span><span class="n">original_index</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">)</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">),</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">))</span>
        <span class="n">axes</span><span class="o">=</span><span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cat</span><span class="p">,</span><span class="n">ax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>
            <span class="n">dft</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dft</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;d1&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;d2&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">cat</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dft</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;d1&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;d2&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span><span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">title</span> <span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">method_dict</span><span class="p">[</span><span class="n">method</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">show</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">method_dict</span><span class="p">[</span><span class="n">method</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">dft</span><span class="p">,</span> <span class="s2">&quot;axes&quot;</span><span class="p">:</span> <span class="n">axes</span><span class="p">}</span></div>


<div class="viewcode-block" id="regression_single"><a class="viewcode-back" href="../../omniplot.html#omniplot.scatter.regression_single">[docs]</a><span class="k">def</span> <span class="nf">regression_single</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> 
                      <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">y</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                      <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;ransac&quot;</span><span class="p">,</span>
                      <span class="n">category</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> 
                      <span class="n">figsize</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">],</span>
                      <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ransac_param</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;max_trials&quot;</span><span class="p">:</span><span class="mi">1000</span><span class="p">},</span>
                      <span class="n">robust_param</span><span class="p">:</span> <span class="nb">dict</span><span class="o">=</span><span class="p">{},</span>
                      <span class="n">xunit</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                      <span class="n">yunit</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                      <span class="n">title</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                      <span class="n">random_state</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
                      <span class="n">ax</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">save</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Drawing a scatter plot with a single variable linear regression.  </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas DataFrame</span>
<span class="sd">    </span>
<span class="sd">    x: str</span>
<span class="sd">        the column name of x axis. </span>
<span class="sd">    y: str</span>
<span class="sd">        the column name of y axis. </span>

<span class="sd">    method: str</span>
<span class="sd">        Method name for regression. Default: ransac</span>
<span class="sd">        Available methods: [&quot;ransac&quot;, </span>
<span class="sd">                            &quot;robust&quot;,</span>
<span class="sd">                            &quot;lasso&quot;,&quot;elastic_net&quot;</span>
<span class="sd">                            ]</span>
<span class="sd">    figsize: list[int]</span>
<span class="sd">        figure size</span>
<span class="sd">    show : bool</span>
<span class="sd">        Whether or not to show the figure.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict: dict {&quot;axes&quot;:ax, &quot;coefficient&quot;:coef,&quot;intercept&quot;:intercept,&quot;coefficient_pval&quot;:coef_p, &quot;r2&quot;:r2, &quot;fitted_model&quot;:fitted_model}</span>
<span class="sd">    </span>
<span class="sd">        fitted_model:</span>
<span class="sd">            this can be used like: y_predict=fitted_model.predict(_X)</span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    
    
    <span class="n">Y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
    <span class="n">_X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">x</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
    <span class="n">plotline_X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">X</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">})</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;ransac&quot;</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">RANSACRegressor</span>
        
        
        
        <span class="n">fit_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">fitted_model</span> <span class="o">=</span> <span class="n">RANSACRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">,</span><span class="o">**</span><span class="n">ransac_param</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">_X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
        <span class="n">fit_df</span><span class="p">[</span><span class="s2">&quot;ransac_regression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fitted_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">plotline_X</span><span class="p">)</span>
        <span class="n">coef</span> <span class="o">=</span> <span class="n">fitted_model</span><span class="o">.</span><span class="n">estimator_</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">intercept</span><span class="o">=</span><span class="n">fitted_model</span><span class="o">.</span><span class="n">estimator_</span><span class="o">.</span><span class="n">intercept_</span>
        <span class="n">inlier_mask</span> <span class="o">=</span> <span class="n">fitted_model</span><span class="o">.</span><span class="n">inlier_mask_</span>
        <span class="n">outlier_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">inlier_mask</span>
        
                                <span class="c1"># number of samples</span>
        <span class="n">y_model</span><span class="o">=</span><span class="n">fitted_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X</span><span class="p">)</span>

        <span class="n">r2</span> <span class="o">=</span> <span class="n">_calc_r2</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
        <span class="c1"># mean squared error</span>
        <span class="n">MSE</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">y_model</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>
        
        <span class="c1"># to plot the adjusted model</span>
        <span class="n">x_line</span> <span class="o">=</span> <span class="n">plotline_X</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">y_line</span> <span class="o">=</span> <span class="n">fit_df</span><span class="p">[</span><span class="s2">&quot;ransac_regression&quot;</span><span class="p">]</span>
         
        <span class="n">ci</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">std_error</span><span class="o">=</span><span class="n">_ci_pi</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">plotline_X</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">y_model</span><span class="p">)</span>
        <span class="n">q</span><span class="o">=</span><span class="p">((</span><span class="n">X</span><span class="o">-</span><span class="n">X</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span> <span class="o">@</span> <span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">X</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">std_error</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">**-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">coef_p</span><span class="o">=</span><span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">fitted_model</span><span class="o">.</span><span class="n">estimator_</span><span class="o">.</span><span class="n">coef_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">sigma</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1">############### Ploting</span>

        <span class="n">_draw_ci_pi</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span><span class="n">x_line</span><span class="p">,</span> <span class="n">y_line</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">X</span><span class="p">[</span><span class="n">inlier_mask</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">Y</span><span class="p">[</span><span class="n">inlier_mask</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Inliers&quot;</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">X</span><span class="p">[</span><span class="n">outlier_mask</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">Y</span><span class="p">[</span><span class="n">outlier_mask</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Outliers&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="c1">#print(r2, MSE,ransac_coef,ransac.estimator_.intercept_)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;RANSAC regression, r2: </span><span class="si">{:.2f}</span><span class="s2">, MSE: </span><span class="si">{:.2f}</span><span class="se">\n</span><span class="s2">y = </span><span class="si">{:.2f}</span><span class="s2"> + </span><span class="si">{:.2f}</span><span class="s2">x, coefficient p-value: </span><span class="si">{:.2E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">r2</span><span class="p">,</span> <span class="n">MSE</span><span class="p">,</span><span class="n">coef</span><span class="p">,</span><span class="n">intercept</span><span class="p">,</span><span class="n">coef_p</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plotline_X</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">fit_df</span><span class="p">[</span><span class="s2">&quot;ransac_regression&quot;</span><span class="p">])</span>
        
        <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="s2">&quot;ransac&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
            <span class="n">_draw_ci_pi</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span><span class="n">x_line</span><span class="p">,</span> <span class="n">y_line</span><span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="c1">#print(r2, MSE,ransac_coef,ransac.estimator_.intercept_)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;RANSAC regression, r2: </span><span class="si">{:.2f}</span><span class="s2">, MSE: </span><span class="si">{:.2f}</span><span class="se">\n</span><span class="s2">y = </span><span class="si">{:.2f}</span><span class="s2"> + </span><span class="si">{:.2f}</span><span class="s2">x, coefficient p-value: </span><span class="si">{:.2E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">r2</span><span class="p">,</span> <span class="n">MSE</span><span class="p">,</span><span class="n">coef</span><span class="p">,</span><span class="n">intercept</span><span class="p">,</span><span class="n">coef_p</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plotline_X</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">fit_df</span><span class="p">[</span><span class="s2">&quot;ransac_regression&quot;</span><span class="p">])</span>
            <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="s2">&quot;ransac_&quot;</span><span class="o">+</span><span class="n">category</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;robust&quot;</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
        <span class="n">rlm_model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">RLM</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">),</span>
        <span class="n">M</span><span class="o">=</span><span class="n">sm</span><span class="o">.</span><span class="n">robust</span><span class="o">.</span><span class="n">norms</span><span class="o">.</span><span class="n">HuberT</span><span class="p">(),</span><span class="o">**</span><span class="n">robust_param</span><span class="p">)</span>
        <span class="n">fitted_model</span> <span class="o">=</span> <span class="n">rlm_model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="n">summary</span><span class="o">=</span><span class="n">fitted_model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
        <span class="n">coef</span><span class="o">=</span><span class="n">fitted_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">intercept</span><span class="o">=</span><span class="n">fitted_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">intercept_p</span><span class="o">=</span><span class="n">fitted_model</span><span class="o">.</span><span class="n">pvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">coef_p</span><span class="o">=</span><span class="n">fitted_model</span><span class="o">.</span><span class="n">pvalues</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">y_model</span><span class="o">=</span><span class="n">fitted_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">_calc_r2</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
        <span class="n">x_line</span> <span class="o">=</span> <span class="n">plotline_X</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">y_line</span> <span class="o">=</span> <span class="n">fitted_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">x_line</span><span class="p">))</span>
        
        <span class="n">ci</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span><span class="n">std_error</span><span class="o">=</span><span class="n">_ci_pi</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">plotline_X</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">y_model</span><span class="p">)</span>
        <span class="n">MSE</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">y_model</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>

        <span class="n">_draw_ci_pi</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span><span class="n">x_line</span><span class="p">,</span> <span class="n">y_line</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
        <span class="c1">#print(r2, MSE,ransac_coef,ransac.estimator_.intercept_)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Robust linear regression, r2: </span><span class="si">{:.2f}</span><span class="s2">, MSE: </span><span class="si">{:.2f}</span><span class="se">\n</span><span class="s2">y = </span><span class="si">{:.2f}</span><span class="s2"> + </span><span class="si">{:.2f}</span><span class="s2">x , p-values: coefficient </span><span class="si">{:.2f}</span><span class="s2">, </span><span class="se">\</span>
<span class="s2">        intercept </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">r2</span><span class="p">,</span> <span class="n">MSE</span><span class="p">,</span><span class="n">coef</span><span class="p">,</span><span class="n">intercept</span><span class="p">,</span><span class="n">coef_p</span><span class="p">,</span><span class="n">intercept_p</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plotline_X</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">y_line</span><span class="p">)</span>
        <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="s2">&quot;robust&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
            <span class="n">_draw_ci_pi</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span><span class="n">x_line</span><span class="p">,</span> <span class="n">y_line</span><span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
            <span class="c1">#print(r2, MSE,ransac_coef,ransac.estimator_.intercept_)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Robust linear regression, r2: </span><span class="si">{:.2f}</span><span class="s2">, MSE: </span><span class="si">{:.2f}</span><span class="se">\n</span><span class="s2">y = </span><span class="si">{:.2f}</span><span class="s2"> + </span><span class="si">{:.2f}</span><span class="s2">x , p-values: coefficient </span><span class="si">{:.2f}</span><span class="s2">, </span><span class="se">\</span>
<span class="s2">            intercept </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">r2</span><span class="p">,</span> <span class="n">MSE</span><span class="p">,</span><span class="n">coef</span><span class="p">,</span><span class="n">intercept</span><span class="p">,</span><span class="n">coef_p</span><span class="p">,</span><span class="n">intercept_p</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plotline_X</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">y_line</span><span class="p">)</span>
            <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="s2">&quot;robust_&quot;</span><span class="o">+</span><span class="n">category</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;lasso&quot;</span> <span class="ow">or</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;elastic_net&quot;</span> <span class="ow">or</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;ols&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;lasso&quot;</span><span class="p">:</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;sqrt_lasso&quot;</span>
        <span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
        <span class="n">rlm_model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;ols&quot;</span><span class="p">:</span>
            <span class="n">fitted_model</span> <span class="o">=</span> <span class="n">rlm_model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fitted_model</span> <span class="o">=</span> <span class="n">rlm_model</span><span class="o">.</span><span class="n">fit_regularized</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="n">coef</span><span class="o">=</span><span class="n">fitted_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">intercept</span><span class="o">=</span><span class="n">fitted_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">y_model</span><span class="o">=</span><span class="n">fitted_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">_calc_r2</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">)</span>
        <span class="n">x_line</span> <span class="o">=</span> <span class="n">plotline_X</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">y_line</span> <span class="o">=</span> <span class="n">fitted_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">x_line</span><span class="p">))</span>
        <span class="n">ci</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">std_error</span><span class="o">=</span><span class="n">_ci_pi</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">plotline_X</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">y_model</span><span class="p">)</span>
        <span class="n">q</span><span class="o">=</span><span class="p">((</span><span class="n">X</span><span class="o">-</span><span class="n">X</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span> <span class="o">@</span> <span class="p">(</span><span class="n">X</span><span class="o">-</span><span class="n">X</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
        <span class="n">sigma</span><span class="o">=</span><span class="n">std_error</span><span class="o">*</span><span class="p">(</span><span class="n">q</span><span class="o">**-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span><span class="n">coef</span> <span class="p">)</span>
        <span class="n">coef_p</span><span class="o">=</span><span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">coef</span><span class="o">/</span><span class="n">sigma</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">MSE</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">(</span><span class="n">Y</span> <span class="o">-</span> <span class="n">y_model</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span>

        <span class="n">_draw_ci_pi</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span><span class="n">x_line</span><span class="p">,</span> <span class="n">y_line</span><span class="p">)</span>   
        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>
        <span class="c1">#print(r2, MSE,ransac_coef,ransac.estimator_.intercept_)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;OLS (</span><span class="si">{}</span><span class="s2">), r2: </span><span class="si">{:.2f}</span><span class="s2">, MSE: </span><span class="si">{:.2f}</span><span class="se">\n</span><span class="s2">y = </span><span class="si">{:.2f}</span><span class="s2"> + </span><span class="si">{:.2f}</span><span class="s2">x, coefficient p-value: </span><span class="si">{:.2E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span>
            <span class="n">r2</span><span class="p">,</span> <span class="n">MSE</span><span class="p">,</span><span class="n">coef</span><span class="p">,</span><span class="n">intercept</span><span class="p">,</span><span class="n">coef_p</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plotline_X</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">y_line</span><span class="p">)</span>
        <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">category</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
            <span class="n">_draw_ci_pi</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span><span class="n">x_line</span><span class="p">,</span> <span class="n">y_line</span><span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span><span class="n">hue</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
            <span class="c1">#print(r2, MSE,ransac_coef,ransac.estimator_.intercept_)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;OLS (</span><span class="si">{}</span><span class="s2">), r2: </span><span class="si">{:.2f}</span><span class="s2">, MSE: </span><span class="si">{:.2f}</span><span class="se">\n</span><span class="s2">y = </span><span class="si">{:.2f}</span><span class="s2"> + </span><span class="si">{:.2f}</span><span class="s2">x, coefficient p-value: </span><span class="si">{:.2E}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">,</span>
                <span class="n">r2</span><span class="p">,</span> <span class="n">MSE</span><span class="p">,</span><span class="n">coef</span><span class="p">,</span><span class="n">intercept</span><span class="p">,</span><span class="n">coef_p</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plotline_X</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">y_line</span><span class="p">)</span>
            <span class="n">_save</span><span class="p">(</span><span class="n">save</span><span class="p">,</span> <span class="n">method</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">category</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;axes&quot;</span><span class="p">:</span><span class="n">ax</span><span class="p">,</span> <span class="s2">&quot;coefficient&quot;</span><span class="p">:</span><span class="n">coef</span><span class="p">,</span><span class="s2">&quot;intercept&quot;</span><span class="p">:</span><span class="n">intercept</span><span class="p">,</span><span class="s2">&quot;coefficient_pval&quot;</span><span class="p">:</span><span class="n">coef_p</span><span class="p">,</span> <span class="s2">&quot;r2&quot;</span><span class="p">:</span><span class="n">r2</span><span class="p">,</span> <span class="s2">&quot;fitted_model&quot;</span><span class="p">:</span><span class="n">fitted_model</span><span class="p">}</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2023, Koh Onimaru.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>